<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>7-Day Performance Dashboard v4.0</title>
<meta name="description" content="Weekly meal calendar, recipes and shopping list for a 56yo Olympic weightlifter." />
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#121212">
<style>
:root{
  --bg:#0f1112;
  --card:#161819;
  --muted:#bfc4c8;
  --accent:#3498db;
  --accent-2:#f1c40f;
  --glass: rgba(255,255,255,0.03);
  --success:#2ecc71;
  --danger:#e74c3c;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#fff;-webkit-font-smoothing:antialiased}
.container{max-width:1100px;margin:0 auto;padding:18px}
header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:12px}
.title{font-weight:700;letter-spacing:0.6px}
.subtitle{color:var(--muted);font-size:0.9rem}
.info{background:var(--card);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.04)}
.row{display:flex;gap:12px;flex-wrap:wrap}
.col{flex:1;min-width:220px}
.card{background:var(--card);border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:10px;margin-bottom:12px}
.h3{font-size:1.05rem;color:var(--accent);margin:0 0 8px 0;padding-left:8px;border-left:4px solid var(--accent);display:inline-block}
.small{color:var(--muted);font-size:0.9rem}
.meal-table{width:100%;border-collapse:collapse;margin-top:8px}
.meal-table th, .meal-table td{padding:8px;border-bottom:1px dashed rgba(255,255,255,0.03);text-align:left;font-size:0.95rem;color:var(--muted)}
.meal-table th{color:#fff;font-weight:600;background:transparent}
.day-card{cursor:pointer;display:block}
.meal-toggle{display:flex;align-items:center;justify-content:space-between;gap:12px}
.meal-toggle .label{font-weight:700}
.meal-details{display:none;margin-top:10px;color:var(--muted)}
.recipe-list li{margin-bottom:8px}
.shopping-list{list-style:none;padding:0;margin:0}
.shopping-list li{display:flex;align-items:center;padding:10px;border-bottom:1px solid rgba(255,255,255,0.02)}
.shopping-list input{transform:scale(1.1);margin-right:12px}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.btn{background:transparent;border:1px solid rgba(255,255,255,0.06);padding:8px 10px;border-radius:8px;color:#fff;cursor:pointer}
.btn.primary{background:var(--accent);border-color:rgba(0,0,0,0.2)}
.badge{background:var(--accent-2);color:#000;padding:4px 8px;border-radius:999px;font-weight:700;margin-left:6px;color:#111}
.footer{margin-top:18px;color:var(--muted);font-size:0.9rem}
@media(min-width:860px){.row .col{flex:1}}
kbd{background:#111;padding:4px 6px;border-radius:6px;border:1px solid rgba(255,255,255,0.03);font-size:0.85rem}

/* Day-picker modal */
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:200}
.picker{background:var(--card);border:1px solid #333;padding:18px;border-radius:12px;width:92%;max-width:420px}
.options{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:12px}
.option-btn{background:transparent;border:1px solid #333;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}
.option-btn:focus{outline:2px solid rgba(52,152,219,0.2)}
.picker .date-row{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.small-note{font-size:0.85rem;color:var(--muted);margin-bottom:8px}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <div class="title">üì± 7-Day Performance Dashboard v4.0</div>
      <div class="subtitle">Athlete: <strong>56 Years</strong> | <strong>93kg</strong> | Olympic Weightlifter</div>
    </div>

    <div style="text-align:right">
      <div id="selectedDateDisplay" class="small" style="margin-bottom:6px;color:var(--muted)"></div>
      <button id="changeDayBtn" class="btn" style="font-size:0.9rem">Change Day</button>
    </div>
  </header>

  <section class="card">
    <div class="h3">üìÖ THE WEEKLY MEAL CALENDAR</div>
    <div class="small" style="margin-top:6px">Tap a day to expand; the picker controls which day is highlighted/expanded.</div>
  </section>

  <!-- Weekly calendar days -->
  <section id="weeklyCalendar">
    <!-- MONDAY & TUESDAY -->
    <article class="card day" data-day="MonTue">
      <button class="day-card" aria-expanded="false" onclick="toggleDay(this)">
        <div class="meal-toggle">
          <div><strong>üü° MONDAY & TUESDAY: High Intensity (3 PM Training)</strong><div class="small">Strategy: High-leucine animal proteins to maximize strength accretion.</div></div>
          <div class="badge">High Intensity</div>
        </div>
      </button>
      <div class="meal-details" aria-hidden="true">
        <table class="meal-table" aria-label="Monday & Tuesday meals">
          <thead><tr><th>Time</th><th>Meal</th><th>Inventory Components</th><th>Est. Macros (P/C/F)</th></tr></thead>
          <tbody>
            <tr><td>08:30</td><td>Breakfast</td><td>4 Eggs, Cheese, Spinach, 1 Potato (hash)</td><td>35 / 30 / 25</td></tr>
            <tr><td>12:30</td><td>Pre-Tr</td><td>170g Chicken Breast, 1 cup Oats (savory), Tomatoes</td><td>55 / 54 / 8</td></tr>
            <tr><td>17:00</td><td>Post-Tr</td><td>1.5 scoops Whey, 1 Banana, Assorted Fruit</td><td>40 / 45 / 2</td></tr>
            <tr><td>19:30</td><td>Dinner</td><td>170g Ground Beef, 100g Pasta, Tomato Sauce</td><td>48 / 80 / 28</td></tr>
            <tr><td>22:00</td><td>Sleep</td><td>1 cup Greek Yogurt, handful of Pecans</td><td>22 / 10 / 18</td></tr>
          </tbody>
        </table>
      </div>
    </article>

    <!-- WEDNESDAY -->
    <article class="card day" data-day="Wed">
      <button class="day-card" aria-expanded="false" onclick="toggleDay(this)">
        <div class="meal-toggle">
          <div><strong>üü¢ WEDNESDAY: Restricted Focus (3 PM Training)</strong><div class="small">Strategy: Meatless protocol using "The Whey Loophole".</div></div>
          <div class="badge" style="background:var(--success)">Restricted</div>
        </div>
      </button>
      <div class="meal-details" aria-hidden="true">
        <table class="meal-table" aria-label="Wednesday meals">
          <thead><tr><th>Time</th><th>Meal</th><th>Inventory Components</th><th>Est. Macros (P/C/F)</th></tr></thead>
          <tbody>
            <tr><td>08:30</td><td>Breakfast</td><td>Protein Oats: 1 cup Oats, 1.5 scoops Whey, Almond Milk</td><td>45 / 55 / 12</td></tr>
            <tr><td>12:30</td><td>Pre-Tr</td><td>Potato-Whey Mash: 2 Potatoes, 1 scoop Whey, Spinach</td><td>35 / 65 / 4</td></tr>
            <tr><td>17:00</td><td>Post-Tr</td><td>1.5 scoops Whey, 1 Banana, 1 tbsp Peanut Butter</td><td>42 / 35 / 10</td></tr>
            <tr><td>19:30</td><td>Dinner</td><td>Whey Marinara Pasta with 30g Almonds</td><td>45 / 80 / 22</td></tr>
            <tr><td>22:00</td><td>Sleep</td><td>Handful of Pistachios, 1 cup Almond Milk</td><td>10 / 5 / 15</td></tr>
          </tbody>
        </table>
      </div>
    </article>

    <!-- THURSDAY -->
    <article class="card day" data-day="Thu">
      <button class="day-card" aria-expanded="false" onclick="toggleDay(this)">
        <div class="meal-toggle">
          <div><strong>üü° THURSDAY: Rest & Tone</strong><div class="small">Strategy: Lower carbohydrates to facilitate body recomposition (toning).</div></div>
          <div class="badge">Rest</div>
        </div>
      </button>
      <div class="meal-details" aria-hidden="true">
        <table class="meal-table" aria-label="Thursday meals">
          <thead><tr><th>Time</th><th>Meal</th><th>Inventory Components</th><th>Est. Macros (P/C/F)</th></tr></thead>
          <tbody>
            <tr><td>09:00</td><td>Breakfast</td><td>4 Eggs, Spinach, Tomatoes, 1/2 Banana</td><td>32 / 15 / 22</td></tr>
            <tr><td>13:00</td><td>Lunch</td><td>200g Chicken Breast, large Salad, 1 Potato</td><td>65 / 35 / 6</td></tr>
            <tr><td>16:30</td><td>Snack</td><td>1 cup Greek Yogurt, handful of Pecans</td><td>22 / 10 / 15</td></tr>
            <tr><td>19:30</td><td>Dinner</td><td>170g Ground Beef, Spinach, 1 oz Cheese (No starch)</td><td>48 / 5 / 34</td></tr>
            <tr><td>21:30</td><td>Sleep</td><td>1 scoop Whey, 1 cup Almond Milk</td><td>26 / 4 / 3</td></tr>
          </tbody>
        </table>
      </div>
    </article>

    <!-- FRIDAY -->
    <article class="card day" data-day="Fri">
      <button class="day-card" aria-expanded="false" onclick="toggleDay(this)">
        <div class="meal-toggle">
          <div><strong>üü¢ FRIDAY: Restricted / Saturday Load (3 PM Training)</strong><div class="small">Strategy: Heavy starch "loading" at dinner for 9 AM Sat session.</div></div>
          <div class="badge" style="background:var(--success)">Restricted</div>
        </div>
      </button>
      <div class="meal-details" aria-hidden="true">
        <table class="meal-table" aria-label="Friday meals">
          <thead><tr><th>Time</th><th>Meal</th><th>Inventory Components</th><th>Est. Macros (P/C/F)</th></tr></thead>
          <tbody>
            <tr><td>08:30</td><td>Breakfast</td><td>Smoothie: Whey, Oats, Banana, Spinach, Almond Milk</td><td>45 / 65 / 8</td></tr>
            <tr><td>12:30</td><td>Pre-Tr</td><td>Peanut Noodle Bowl: Pasta, 2 tbsp PB, Tomatoes</td><td>20 / 75 / 18</td></tr>
            <tr><td>17:00</td><td>Post-Tr</td><td>1.5 scoops Whey, 1 cup Assorted Fruit</td><td>38 / 30 / 2</td></tr>
            <tr><td>19:30</td><td>Dinner</td><td>Double Pasta serving, Whey Marinara, 1 Potato</td><td>52 / 130 / 24</td></tr>
          </tbody>
        </table>
      </div>
    </article>

    <!-- SATURDAY -->
    <article class="card day" data-day="Sat">
      <button class="day-card" aria-expanded="false" onclick="toggleDay(this)">
        <div class="meal-toggle">
          <div><strong>üü° SATURDAY: Peak Power (9 AM Training)</strong><div class="small">Strategy: Rapid liquid intake pre-session; large recovery "Skillet" post-session.</div></div>
          <div class="badge">Peak</div>
        </div>
      </button>
      <div class="meal-details" aria-hidden="true">
        <table class="meal-table" aria-label="Saturday meals">
          <thead><tr><th>Time</th><th>Meal</th><th>Inventory Components</th><th>Est. Macros (P/C/F)</th></tr></thead>
          <tbody>
            <tr><td>07:30</td><td>Pre-Tr</td><td>1 scoop Whey, 1 Banana (blended with water)</td><td>26 / 30 / 1</td></tr>
            <tr><td>11:00</td><td>Recovery</td><td>The Skillet: 4 Eggs, 2 Potatoes, Cheese, Spinach</td><td>35 / 65 / 28</td></tr>
            <tr><td>14:30</td><td>Lunch</td><td>150g Chicken Breast, 1 cup Greek Yogurt, Fruit</td><td>60 / 30 / 6</td></tr>
            <tr><td>18:30</td><td>Dinner</td><td>Ground Beef & Pasta Skillet, 1 oz Cheese</td><td>48 / 60 / 34</td></tr>
            <tr><td>21:30</td><td>Sleep</td><td>Handful of Almonds, 1 cup Almond Milk</td><td>8 / 4 / 15</td></tr>
          </tbody>
        </table>
      </div>
    </article>
  </section>

  <!-- Recipes -->
  <section class="card" id="recipes">
    <div class="h3">üç≥ SAVORY RECIPE COOKBOOK</div>
    <ol class="recipe-list" style="margin-top:8px;color:var(--muted)">
      <li><strong>Savory Whey Marinara</strong><div class="small">100g pasta, 150g tomato sauce, 1.5 scoops whey, 30g almonds, spinach. Whisk whey into cold sauce, heat LOW, toss with pasta.</div></li>
      <li style="margin-top:10px"><strong>The Weightlifter‚Äôs Skillet</strong><div class="small">170g beef, 250g potatoes, tomatoes, cheese, spinach. Pan-fry potatoes, brown beef, combine.</div></li>
      <li style="margin-top:10px"><strong>Protein Pro Savory Oats</strong><div class="small">1 cup oats, 1 cup almond milk, 1.5 scoops whey, PB, banana. Cook oats, stir in whey, top.</div></li>
    </ol>
  </section>

  <!-- Shopping -->
  <section class="card" id="shoppingSection" aria-labelledby="shoppingHeading">
    <div class="h3">üõí WEEKLY SHOPPING LIST (Quantities for 93kg Athlete)</div>
    <div class="controls" style="margin-top:10px">
      <button class="btn" id="clearChecks">Clear checks</button>
      <button class="btn" id="exportList">Export .txt</button>
      <div style="flex:1"></div>
      <div class="small">Checked state saved locally</div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px">
      <div class="card">
        <strong class="small">ü•© PROTEINS</strong>
        <ul class="shopping-list" id="proteins">
          <li><input type="checkbox" data-key="Chicken Breast"> Chicken Breast: 700g total</li>
          <li><input type="checkbox" data-key="Ground Beef"> Ground Beef (90% Lean): 700g total</li>
          <li><input type="checkbox" data-key="Canned Tuna"> Canned Tuna (Oil): 4 Cans</li>
          <li><input type="checkbox" data-key="Whey"> Whey Isolate: 1 Large Tub</li>
        </ul>
      </div>

      <div class="card">
        <strong class="small">ü•õ DAIRY & CHILLED</strong>
        <ul class="shopping-list" id="dairy">
          <li><input type="checkbox" data-key="Eggs"> Eggs: 2 Dozen</li>
          <li><input type="checkbox" data-key="Greek Yogurt"> Greek Yogurt (Plain): 1kg</li>
          <li><input type="checkbox" data-key="Cheese"> Cheese (Cheddar/Hard): 250g</li>
          <li><input type="checkbox" data-key="Almond Milk"> Almond Milk (Unsweetened): 4 L</li>
        </ul>
      </div>

      <div class="card">
        <strong class="small">ü•¶ PRODUCE</strong>
        <ul class="shopping-list" id="produce">
          <li><input type="checkbox" data-key="Bananas"> Bananas: 14</li>
          <li><input type="checkbox" data-key="Potatoes"> Potatoes: 12 Large</li>
          <li><input type="checkbox" data-key="Spinach"> Spinach: 6 Large Bags</li>
          <li><input type="checkbox" data-key="Cherry Tomatoes"> Cherry Tomatoes: 4 Pints</li>
          <li><input type="checkbox" data-key="Assorted Fruits"> Assorted Fruits: 4 Packs</li>
        </ul>
      </div>

      <div class="card">
        <strong class="small">üçù PANTRY & NUTS</strong>
        <ul class="shopping-list" id="pantry">
          <li><input type="checkbox" data-key="Rolled Oats"> Rolled Oats: 1kg</li>
          <li><input type="checkbox" data-key="Pasta"> Pasta: 2 Boxes</li>
          <li><input type="checkbox" data-key="Tomato Sauce"> Tomato Sauce: 4 Jars</li>
          <li><input type="checkbox" data-key="Peanut Butter"> Peanut Butter: 1 Large Jar</li>
          <li><input type="checkbox" data-key="Mixed Nuts"> Mixed Nuts: 1 Bag each</li>
        </ul>
      </div>
    </div>
  </section>

  <div class="footer">Tip: Use <kbd>Export</kbd> to save a plain-text copy of the shopping list. Use Safari's "Add to Home Screen" to install on iPhone.</div>
</div>

<!-- Day-picker modal -->
<div id="dayPickerBackdrop" class="modal-backdrop" aria-hidden="true">
  <div class="picker" role="dialog" aria-modal="true" aria-labelledby="pickerTitle">
    <h3 id="pickerTitle">Choose a day</h3>
    <div class="small-note">Quick picks (today ¬±3 days)</div>
    <div id="quickOptions" class="options" aria-hidden="false"></div>

    <div class="small-note">Or pick an exact date</div>
    <div class="date-row" style="display:flex;gap:8px;margin-bottom:10px">
      <input id="dateInput" type="date" style="flex:1;padding:8px;background:#141414;border:1px solid #333;color:var(--muted)">
      <button id="pickDateBtn" class="btn">Select</button>
    </div>

    <div style="display:flex;justify-content:space-between;align-items:center">
      <label style="font-size:0.9rem;color:var(--muted);display:flex;align-items:center;gap:8px">
        <input id="dontAskAgain" type="checkbox"> Don't ask again
      </label>
      <div>
        <button id="cancelPicker" class="btn" style="margin-right:8px">Cancel</button>
        <button id="useToday" class="btn primary">Use Today</button>
      </div>
    </div>
  </div>
</div>

<script>
/* ---------- Helpers ---------- */
function $(sel, root=document){ return root.querySelector(sel); }
function $all(sel, root=document){ return Array.from(root.querySelectorAll(sel)); }
function formatDateTitle(d){
  const days=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
  const months=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;
}
function toISO(d){ const y=d.getFullYear(); const m=('0'+(d.getMonth()+1)).slice(-2); const day=('0'+d.getDate()).slice(-2); return `${y}-${m}-${day}`; }
function fromISO(s){ const p=s.split('-').map(Number); return new Date(p[0],p[1]-1,p[2]); }

/* ---------- Day-picker ---------- */
const DAY_KEY = 'perfdash_selected_date_v2';
const SKIP_KEY = 'perfdash_skip_dayprompt_v2';

const backdrop = $('#dayPickerBackdrop');
const quickOptions = $('#quickOptions');
const dateInput = $('#dateInput');
const pickDateBtn = $('#pickDateBtn');
const cancelPicker = $('#cancelPicker');
const useToday = $('#useToday');
const dontAskAgain = $('#dontAskAgain');
const changeDayBtn = $('#changeDayBtn');
const selectedDateDisplay = $('#selectedDateDisplay');

function buildQuickOptions(){
  quickOptions.innerHTML = '';
  const today = new Date();
  const range = 3;
  for(let offset=-range; offset<=range; offset++){
    const d = new Date(today); d.setDate(today.getDate()+offset);
    const btn = document.createElement('button');
    btn.className = 'option-btn';
    btn.type = 'button';
    btn.textContent = offset===0 ? `Today ‚Äî ${formatDateTitle(d)}` :
                    offset===1 ? `Tomorrow ‚Äî ${formatDateTitle(d)}` :
                    offset===-1 ? `Yesterday ‚Äî ${formatDateTitle(d)}` :
                    `${formatDateTitle(d)}`;
    btn.dataset.iso = toISO(d);
    btn.addEventListener('click', ()=> pickDay(btn.dataset.iso));
    quickOptions.appendChild(btn);
  }
}

function showDayPicker(force=false){
  const skip = localStorage.getItem(SKIP_KEY) === 'true';
  if(skip && !force){
    const stored = localStorage.getItem(DAY_KEY);
    if(stored){ setSelectedDate(fromISO(stored)); return; }
  }
  buildQuickOptions();
  dateInput.value = toISO(new Date());
  dontAskAgain.checked = false;
  backdrop.style.display = 'flex';
  backdrop.setAttribute('aria-hidden','false');
  const first = quickOptions.querySelector('.option-btn');
  if(first) first.focus();
}

function hideDayPicker(){ backdrop.style.display = 'none'; backdrop.setAttribute('aria-hidden','true'); }

function setSelectedDate(d){
  if(!(d instanceof Date) || isNaN(d)) return;
  // show in header
  selectedDateDisplay.textContent = `Selected: ${formatDateTitle(d)}`;
  // persist
  localStorage.setItem(DAY_KEY, toISO(d));
  if(dontAskAgain.checked) localStorage.setItem(SKIP_KEY, 'true');
  // expand correct day card
  expandDayForDate(d);
  hideDayPicker();
}

/* Map weekday to data-day attribute */
function weekdayToDataDay(d){
  // 0=Sun ... 6=Sat
  const wd = d.getDay();
  switch(wd){
    case 1: return 'MonTue'; // Monday
    case 2: return 'MonTue'; // Tuesday
    case 3: return 'Wed';
    case 4: return 'Thu';
    case 5: return 'Fri';
    case 6: return 'Sat';
    case 0: return 'MonTue'; // Sunday -> show MonTue
    default: return 'MonTue';
  }
}

function expandDayForDataAttr(attr){
  // collapse all first
  $all('.meal-details').forEach(detail => { detail.style.display='none'; detail.setAttribute('aria-hidden','true'); });
  $all('.day-card').forEach(btn => btn.setAttribute('aria-expanded','false'));
  // find article(s) that match attr and expand
  const article = document.querySelector(`.day[data-day="${attr}"]`);
  if(article){
    const details = article.querySelector('.meal-details');
    if(details){
      details.style.display='block';
      details.setAttribute('aria-hidden','false');
      const btn = article.querySelector('.day-card');
      if(btn) btn.setAttribute('aria-expanded','true');
      // scroll into view a bit smoothly
      setTimeout(()=> article.scrollIntoView({behavior:'smooth', block:'center'}), 120);
    }
  }
}

function expandDayForDate(d){
  const attr = weekdayToDataDay(d);
  expandDayForDataAttr(attr);
}

function pickDay(iso){
  setSelectedDate(fromISO(iso));
}

/* Wire picker controls */
pickDateBtn.addEventListener('click', ()=> {
  const iso = dateInput.value;
  if(!iso) return;
  pickDay(iso);
});
useToday.addEventListener('click', ()=> pickDay(toISO(new Date())));
cancelPicker.addEventListener('click', ()=> {
  hideDayPicker();
  const stored = localStorage.getItem(DAY_KEY);
  if(stored) setSelectedDate(fromISO(stored));
});
backdrop.addEventListener('click', (e)=> { if(e.target === backdrop) cancelPicker(); });
document.addEventListener('keydown', (e)=> { if(e.key === 'Escape' && backdrop.style.display === 'flex') cancelPicker(); });
changeDayBtn.addEventListener('click', ()=> showDayPicker(true));

/* ---------- Day expand/collapse (buttons on day cards) ---------- */
function toggleDay(btn){
  const article = btn.closest('.day');
  const details = article.querySelector('.meal-details');
  const expanded = btn.getAttribute('aria-expanded') === 'true';
  if(expanded){
    details.style.display='none'; details.setAttribute('aria-hidden','true'); btn.setAttribute('aria-expanded','false');
  } else {
    // collapse others
    $all('.meal-details').forEach(d=> { d.style.display='none'; d.setAttribute('aria-hidden','true'); });
    $all('.day-card').forEach(b=> b.setAttribute('aria-expanded','false'));
    details.style.display='block'; details.setAttribute('aria-hidden','false'); btn.setAttribute('aria-expanded','true');
  }
}

/* ---------- Shopping persistence & export ---------- */
const SHOP_KEY = 'perfdash_shopping_v2';
function loadShopping(){
  try {
    const raw = localStorage.getItem(SHOP_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    $all('#shoppingSection input[type="checkbox"]').forEach(cb=>{
      const k = cb.dataset.key || cb.id;
      cb.checked = !!obj[k];
    });
  } catch(e){ console.warn(e); }
}
function saveShopping(){
  try {
    const obj = {};
    $all('#shoppingSection input[type="checkbox"]').forEach(cb=>{
      const k = cb.dataset.key || cb.id;
      obj[k] = !!cb.checked;
    });
    localStorage.setItem(SHOP_KEY, JSON.stringify(obj));
  } catch(e){ console.warn(e); }
}
$all('#shoppingSection input[type="checkbox"]').forEach(cb => cb.addEventListener('change', saveShopping));
$('#clearChecks').addEventListener('click', ()=> {
  $all('#shoppingSection input[type="checkbox"]').forEach(cb=> cb.checked=false);
  saveShopping();
});
$('#exportList').addEventListener('click', ()=> {
  const lines = [];
  $all('#shoppingSection .shopping-list').forEach(list=>{
    list.querySelectorAll('li').forEach(li=>{
      const cb = li.querySelector('input[type="checkbox"]');
      const text = li.textContent.trim();
      const status = cb && cb.checked ? '[x]' : '[ ]';
      lines.push(`${status} ${text}`);
    });
  });
  const blob = new Blob([lines.join('\n')], {type:'text/plain'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `shopping-${(new Date()).toISOString().slice(0,10)}.txt`; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
});

/* ---------- Small helpers & init ---------- */
function $(s,r=document){ return r.querySelector(s); }
function $all(s,r=document){ return Array.from(r.querySelectorAll(s)); }

(function init(){
  // make day headers keyboard accessible
  $all('.day-card').forEach(b => { b.setAttribute('tabindex','0'); b.setAttribute('role','button'); });

  // load persisted shopping state
  loadShopping();

  // load selected date and expand appropriate day, or show picker
  const skip = localStorage.getItem(SKIP_KEY) === 'true';
  const stored = localStorage.getItem(DAY_KEY);
  if(stored && skip){
    const d = fromISO(stored);
    selectedDateDisplay.textContent = `Selected: ${formatDateTitle(d)}`;
    expandDayForDate(d);
  } else if(stored && !skip){
    // show picker but preselect stored date visually
    const d = fromISO(stored);
    selectedDateDisplay.textContent = `Selected: ${formatDateTitle(d)}`;
    showDayPicker(false);
  } else {
    // no stored date -> show picker
    showDayPicker(false);
  }
})();

/* ---------- Service worker registration (optional) ---------- */
if('serviceWorker' in navigator){
  window.addEventListener('load', async () => {
    try {
      await navigator.serviceWorker.register('/sw.js');
      console.log('Service worker registered');
    } catch(err) {
      console.warn('SW registration failed', err);
    }
  });
}
</script>
</body>
</html>